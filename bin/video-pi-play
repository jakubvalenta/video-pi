#!/bin/bash

if fd --version &> /dev/null; then
    fd_cmd=fd
elif fdfind --version &> /dev/null; then
    fd_cmd=fdfind
else
    echo "fd is not installed" >&2
    exit 2
fi

set -euo pipefail

if [[ $# -ne 1 ]]; then
    echo "Usage: ${0##} <path>" >&2
    exit 1
fi

path=$1

files=$($fd_cmd -t f --ignore-file /etc/video-pi.fdignore . "$path" | sort)
if [[ -z "$files" ]]; then
    exit 0
fi

n_files=$(echo "$files" | wc -l)
n_images=$(echo "$files" | grep -c -iE '\.(avif|bmp|gif|heic|jpe?g|png|svg|tif?f|webm|webp)$' || true)

if [[ $n_files -eq $n_images ]]; then
    cmd=(eog -fs)
else
    cmd=(cvlc -fL --no-metadata-network-access --no-osd --no-qt-privacy-ask --video-on-top)
fi

echo "$files" | tr '\n' '\0' | xargs -0 "${cmd[@]}"
